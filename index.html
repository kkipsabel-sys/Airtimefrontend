<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtime Solutions - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a73e8;
            --secondary: #34a853;
            --accent: #fbbc04;
            --dark: #202124;
            --light: #f8f9fa;
            --error: #ea4335;
            --success: #34a853;
            --warning: #fbbc04;
            --info: #4285f4;
            --sidebar-width: 260px;
        }

        body {
            background: var(--light);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
        }

        .menu-toggle:hover {
            background: var(--light);
        }

        .menu-toggle svg {
            width: 24px;
            height: 24px;
            color: var(--dark);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .logo span {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-greeting {
            font-size: 14px;
            color: #666;
        }

        .user-greeting strong {
            color: var(--dark);
        }

        .balance-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary), #0d47a1);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        .refresh-btn svg {
            width: 18px;
            height: 18px;
        }

        .notification-bell {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .notification-bell:hover {
            background: var(--light);
        }

        .notification-bell svg {
            width: 24px;
            height: 24px;
            color: #666;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--error);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 65px;
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - 65px);
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 99;
            transition: transform 0.3s ease;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 65px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 98;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(26,115,232,0.08);
            color: var(--primary);
        }

        .nav-item.active {
            background: rgba(26,115,232,0.12);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .nav-item svg {
            width: 22px;
            height: 22px;
        }

        .nav-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 15px 20px;
        }

        .nav-item.logout {
            color: var(--error);
        }

        .nav-item.logout:hover {
            background: rgba(234,67,53,0.08);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: 65px;
            padding: 30px;
            min-height: calc(100vh - 65px);
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title svg {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card.primary {
            background: linear-gradient(135deg, var(--primary), #0d47a1);
            color: white;
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, var(--secondary), #1e7e34);
            color: white;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-icon {
            float: right;
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon svg {
            width: 28px;
            height: 28px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .quick-action-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(26,115,232,0.2);
        }

        .quick-action-btn svg {
            width: 32px;
            height: 32px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .quick-action-btn span {
            display: block;
            font-weight: 500;
            color: var(--dark);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
        }

        .form-group input.invalid {
            border-color: var(--error);
        }

        .form-group .feedback {
            font-size: 12px;
            margin-top: 6px;
            color: var(--error);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .checkbox-group label {
            font-size: 14px;
            color: #666;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26,115,232,0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #1e7e34;
        }

        .btn-full {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn-text { display: inline; }
        .btn-loader { display: none; }
        .btn.loading .btn-text { display: none; }
        .btn.loading .btn-loader { display: inline-flex; align-items: center; gap: 8px; }

        /* Rate Info */
        .rate-info {
            background: rgba(26,115,232,0.08);
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 20px;
        }

        .rate-info p {
            color: var(--dark);
            font-size: 14px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        tr:hover {
            background: rgba(26,115,232,0.03);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: rgba(52,168,83,0.15);
            color: var(--success);
        }

        .status-pending {
            background: rgba(251,188,4,0.15);
            color: #f57c00;
        }

        .status-failed {
            background: rgba(234,67,53,0.15);
            color: var(--error);
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        /* Notifications Container */
        #notificationContainer {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }

        .notification {
            padding: 16px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            color: white;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .notification-success { background: var(--success); }
        .notification-error { background: var(--error); }
        .notification-warning { background: var(--warning); color: var(--dark); }
        .notification-info { background: var(--info); }

        .notification svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .notification span {
            flex: 1;
            font-size: 14px;
        }

        .notification button {
            background: none;
            border: none;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.8;
        }

        /* Settings */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
            color: var(--dark);
        }

        .setting-value {
            color: #666;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            border-radius: 26px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input {
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .filters select:focus,
        .filters input:focus {
            border-color: var(--primary);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 14px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.open {
                display: block;
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 15px;
            }

            .user-greeting {
                display: none;
            }

            .balance-display {
                padding: 6px 12px;
                font-size: 14px;
            }

            .main-content {
                padding: 20px 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .logo span {
                display: none;
            }
        }

        @media (max-width: 480px) {
            #notificationContainer {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="notificationContainer"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <div class="logo">
                <img src="airtime logo.png" alt="Logo" onerror="this.style.display='none'">
                <span>Airtime Solutions</span>
            </div>
        </div>
        <div class="header-right">
            <span class="user-greeting">Hello, <strong id="headerUsername">User</strong></span>
            <div class="balance-display">
                <span>KES <span id="headerBalance">0.00</span></span>
                <button class="refresh-btn" onclick="refreshBalance()" title="Refresh Balance">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                </button>
            </div>
            <button class="notification-bell" onclick="showPage('notifications')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <button class="profile-btn" id="profileInitial" onclick="showPage('settings')">U</button>
        </div>
    </header>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <button class="nav-item active" onclick="showPage('dashboard')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
            </svg>
            Dashboard
        </button>
        <button class="nav-item" onclick="showPage('buy-airtime')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
            Buy Airtime
        </button>
        <button class="nav-item" onclick="showPage('sell-airtime')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            Sell Airtime
        </button>
        <button class="nav-item" onclick="showPage('deposit')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            Deposit
        </button>
        <button class="nav-item" onclick="showPage('withdraw')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 4H3a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"/>
            </svg>
            Withdraw
        </button>
        <div class="nav-divider"></div>
        <button class="nav-item" onclick="showPage('transactions')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Transactions
        </button>
        <button class="nav-item" onclick="showPage('settings')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Settings
        </button>
        <div class="nav-divider"></div>
        <button class="nav-item logout" onclick="logout()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Logout
        </button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page active">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Welcome back, <span id="dashboardUsername">User</span>!</h2>
            
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                            <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                    </div>
                    <div class="stat-label">Main Balance</div>
                    <div class="stat-value">KES <span id="mainBalance">0.00</span></div>
                </div>
                <div class="stat-card secondary">
                    <div class="stat-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                    <div class="stat-label">Bonus Balance</div>
                    <div class="stat-value">KES <span id="bonusBalance">0.00</span></div>
                </div>
            </div>

            <h3 style="margin-bottom: 16px; color: var(--dark);">Quick Actions</h3>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="showPage('buy-airtime')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                    <span>Buy Airtime</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('sell-airtime')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <span>Sell Airtime</span>
                </button>
                <button class="quick-action-btn" onclick="showPage('deposit')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    <span>Deposit</span>
                </button>
            </div>

            <div class="card">
                <h3 class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/>
                        <line x1="8" y1="12" x2="21" y2="12"/>
                        <line x1="8" y1="18" x2="21" y2="18"/>
                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    Recent Transactions
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #666;">No transactions yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Buy Airtime Page -->
        <div id="page-buy-airtime" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Buy Airtime</h2>
            <div class="card" style="max-width: 500px;">
                <form onsubmit="handleBuyAirtime(event)">
                    <div class="form-group">
                        <label>Network Provider</label>
                        <select id="buyNetwork" required>
                            <option value="">Select Network</option>
                            <option value="safaricom">Safaricom</option>
                            <option value="airtel">Airtel</option>
                            <option value="telkom">Telkom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="buyPhone" placeholder="254XXXXXXXXX or 07XXXXXXXX" required>
                        <span class="feedback" id="buyPhoneFeedback"></span>
                    </div>
                    <div class="form-group">
                        <label>Amount (KES)</label>
                        <input type="number" id="buyAmount" placeholder="Minimum 5" min="5" required>
                        <span class="feedback" id="buyAmountFeedback"></span>
                    </div>
                    <div class="checkbox-group" id="bonusCheckboxGroup" style="display: none;">
                        <input type="checkbox" id="useBonus">
                        <label for="useBonus">Use Bonus Balance (<span id="availableBonus">0</span> KES available)</label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full" id="buyAirtimeBtn">
                        <span class="btn-text">Buy Airtime</span>
                        <span class="btn-loader">
                            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                            </svg>
                            Processing...
                        </span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Sell Airtime Page -->
        <div id="page-sell-airtime" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Sell Airtime</h2>
            <div class="card" style="max-width: 500px;">
                <div class="rate-info">
                    <p><strong>Selling Rate: 95%</strong> - You receive KES 95 for every KES 100 airtime sold</p>
                </div>
                <form onsubmit="handleSellAirtime(event)">
                    <div class="form-group">
                        <label>Network Provider</label>
                        <select id="sellNetwork" required>
                            <option value="">Select Network</option>
                            <option value="safaricom">Safaricom</option>
                            <option value="airtel">Airtel</option>
                            <option value="telkom">Telkom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Airtime Amount to Sell (KES)</label>
                        <input type="number" id="sellAmount" placeholder="Minimum 50" min="50" required oninput="calculateSellReceive()">
                        <span class="feedback" style="color: var(--success);" id="sellReceiveAmount"></span>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="sellPaymentMethod" value="push" checked onchange="toggleSellPhone()">
                                PayNecta Push (M-Pesa)
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="sellPaymentMethod" value="balance" onchange="toggleSellPhone()">
                                Add to Balance
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="sellPhoneGroup">
                        <label>Phone Number to Receive Payment</label>
                        <input type="tel" id="sellPhone" placeholder="254XXXXXXXXX">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full" id="sellAirtimeBtn">
                        <span class="btn-text">Sell Airtime</span>
                        <span class="btn-loader">
                            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                            </svg>
                            Processing...
                        </span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Deposit Page -->
        <div id="page-deposit" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Deposit Funds</h2>
            <div class="card" style="max-width: 500px;">
                <div class="rate-info">
                    <p><strong>Bonus:</strong> Deposit KES 50+ and receive <span style="color: var(--success);">+6 KES bonus!</span></p>
                </div>
                <form onsubmit="handleDeposit(event)">
                    <div class="form-group">
                        <label>Amount (KES)</label>
                        <input type="number" id="depositAmount" placeholder="Minimum 10" min="10" required>
                    </div>
                    <div class="form-group">
                        <label>M-Pesa Phone Number</label>
                        <input type="tel" id="depositPhone" placeholder="254XXXXXXXXX" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full" id="depositBtn">
                        <span class="btn-text">Deposit Now</span>
                        <span class="btn-loader">
                            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                            </svg>
                            Sending STK Push...
                        </span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Withdraw Page -->
        <div id="page-withdraw" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Withdraw Funds</h2>
            <div class="card" style="max-width: 500px;">
                <form onsubmit="handleWithdraw(event)">
                    <div class="form-group">
                        <label>Amount (KES)</label>
                        <input type="number" id="withdrawAmount" placeholder="Minimum 50" min="50" required>
                        <span class="feedback" id="withdrawFeedback"></span>
                    </div>
                    <div class="form-group">
                        <label>M-Pesa Phone Number</label>
                        <input type="tel" id="withdrawPhone" placeholder="254XXXXXXXXX" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full" id="withdrawBtn">
                        <span class="btn-text">Withdraw</span>
                        <span class="btn-loader">
                            <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                            </svg>
                            Processing...
                        </span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Transactions Page -->
        <div id="page-transactions" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Transaction History</h2>
            <div class="card">
                <div class="filters">
                    <select id="filterType" onchange="loadTransactions()">
                        <option value="all">All Types</option>
                        <option value="deposit">Deposits</option>
                        <option value="airtime_purchase">Airtime Purchases</option>
                        <option value="airtime_to_cash">Sell Airtime</option>
                        <option value="withdrawal">Withdrawals</option>
                    </select>
                    <select id="filterStatus" onchange="loadTransactions()">
                        <option value="all">All Status</option>
                        <option value="success">Success</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportPDF()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export PDF
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Reference</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #666;">Loading transactions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Settings</h2>
            <div class="card" style="max-width: 600px;">
                <h3 class="card-title">Profile Information</h3>
                <div class="setting-item">
                    <span class="setting-label">Username</span>
                    <span class="setting-value" id="settingsUsername">-</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Email</span>
                    <span class="setting-value" id="settingsEmail">-</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Phone</span>
                    <span class="setting-value" id="settingsPhone">-</span>
                </div>
            </div>

            <div class="card" style="max-width: 600px;">
                <h3 class="card-title">Preferences</h3>
                <div class="setting-item">
                    <span class="setting-label">Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Language</span>
                    <select id="languageSelect" onchange="changeLanguage()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #e0e0e0;">
                        <option value="en">English</option>
                        <option value="sw">Kiswahili</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Notifications Page -->
        <div id="page-notifications" class="page">
            <h2 style="margin-bottom: 24px; color: var(--dark);">Notifications</h2>
            <div class="card">
                <div id="notificationsList">
                    <p style="text-align: center; color: #666;">No notifications</p>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const BACKEND_URL = 'https://airtimebackend.onrender.com';

        // SVG Icons
        const icons = {
            success: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            error: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
            warning: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`
        };

        let currentUser = null;
        let currentPage = 1;

        // Session Check
        function checkSession() {
            const token = localStorage.getItem('user_token');
            const loginTimestamp = localStorage.getItem('login_timestamp');
            const userData = localStorage.getItem('user_data');
            
            if (!token || !userData || !loginTimestamp) {
                showNotification('Session expired. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
            }
            
            const now = Date.now();
            const loginTime = parseInt(loginTimestamp);
            const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
            
            if (hoursDiff >= 24) {
                localStorage.clear();
                showNotification('Session expired after 24 hours. Please login again.', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return false;
            }
            
            return true;
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            notification.innerHTML = `
                ${icons[type]}
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Phone Number Formatter
        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '254' + cleaned.substring(1);
            } else if (cleaned.startsWith('+254')) {
                cleaned = cleaned.substring(1);
            } else if (!cleaned.startsWith('254')) {
                cleaned = '254' + cleaned;
            }
            return cleaned;
        }

        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        }

        // Show Page
        function showPage(pageName) {
            if (!checkSession()) return;
            
            // Close sidebar on mobile
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[onclick="showPage('${pageName}')"]`);
            if (navItem) navItem.classList.add('active');
            
            // Show page
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            
            // Load page-specific data
            if (pageName === 'transactions') {
                loadTransactions();
            } else if (pageName === 'notifications') {
                loadNotifications();
            }
        }

        // Button Loading State
        function setLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (isLoading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Refresh Balance
        async function refreshBalance() {
            const username = localStorage.getItem('username');
            if (!username) {
                showNotification('Unable to refresh. Please login again.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/${username}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('user_data', JSON.stringify(data.user));
                    updateUserDisplay();
                    showNotification('Balance refreshed!', 'success');
                } else {
                    showNotification('Failed to refresh balance', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Update User Display
        function updateUserDisplay() {
            if (!currentUser) return;
            
            const username = currentUser.username || 'User';
            const balance = parseFloat(currentUser.balance || 0).toFixed(2);
            const bonus = parseFloat(currentUser.bonus_balance || 0).toFixed(2);
            
            document.getElementById('headerUsername').textContent = username;
            document.getElementById('dashboardUsername').textContent = username;
            document.getElementById('headerBalance').textContent = balance;
            document.getElementById('mainBalance').textContent = balance;
            document.getElementById('bonusBalance').textContent = bonus;
            document.getElementById('profileInitial').textContent = username.charAt(0).toUpperCase();
            
            // Settings
            document.getElementById('settingsUsername').textContent = username;
            document.getElementById('settingsEmail').textContent = currentUser.email || '-';
            document.getElementById('settingsPhone').textContent = currentUser.phone || '-';
            
            // Bonus checkbox
            if (parseFloat(bonus) > 0) {
                document.getElementById('bonusCheckboxGroup').style.display = 'flex';
                document.getElementById('availableBonus').textContent = bonus;
            }
            
            // Prefill deposit phone
            if (currentUser.phone) {
                document.getElementById('depositPhone').value = currentUser.phone;
            }
        }

        // Calculate Sell Receive Amount
        function calculateSellReceive() {
            const amount = parseFloat(document.getElementById('sellAmount').value) || 0;
            const receiveAmount = (amount * 0.95).toFixed(2);
            document.getElementById('sellReceiveAmount').textContent = amount > 0 ? `You will receive: KES ${receiveAmount}` : '';
        }

        // Toggle Sell Phone Field
        function toggleSellPhone() {
            const method = document.querySelector('input[name="sellPaymentMethod"]:checked').value;
            document.getElementById('sellPhoneGroup').style.display = method === 'push' ? 'block' : 'none';
        }

        // Handle Buy Airtime
        async function handleBuyAirtime(event) {
            event.preventDefault();
            if (!checkSession()) return;
            
            const network = document.getElementById('buyNetwork').value;
            const phone = document.getElementById('buyPhone').value;
            const amount = parseFloat(document.getElementById('buyAmount').value);
            const useBonus = document.getElementById('useBonus').checked;
            
            if (amount < 5) {
                showNotification('Minimum amount is KES 5', 'error');
                return;
            }
            
            const formattedPhone = formatPhoneNumber(phone);
            if (!/^254(7|1)\d{8}$/.test(formattedPhone)) {
                showNotification('Invalid phone number format', 'error');
                return;
            }
            
            // Check balance
            const availableBalance = parseFloat(currentUser.balance || 0) + (useBonus ? parseFloat(currentUser.bonus_balance || 0) : 0);
            if (amount > availableBalance) {
                showNotification(`Insufficient balance. You have KES ${availableBalance.toFixed(2)}`, 'error');
                return;
            }
            
            setLoading('buyAirtimeBtn', true);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/airtime/topup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        phone: formattedPhone,
                        amount: amount,
                        network: network,
                        use_bonus: useBonus
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Airtime sent successfully!', 'success');
                    refreshBalance();
                    document.getElementById('buyPhone').value = '';
                    document.getElementById('buyAmount').value = '';
                } else {
                    showNotification(data.message || 'Failed to send airtime', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            }
            
            setLoading('buyAirtimeBtn', false);
        }

        // Handle Sell Airtime
        async function handleSellAirtime(event) {
            event.preventDefault();
            if (!checkSession()) return;
            
            const network = document.getElementById('sellNetwork').value;
            const amount = parseFloat(document.getElementById('sellAmount').value);
            const paymentMethod = document.querySelector('input[name="sellPaymentMethod"]:checked').value;
            const phone = document.getElementById('sellPhone').value;
            
            if (amount < 50) {
                showNotification('Minimum amount is KES 50', 'error');
                return;
            }
            
            if (paymentMethod === 'push' && !phone) {
                showNotification('Please enter phone number for payment', 'error');
                return;
            }
            
            setLoading('sellAirtimeBtn', true);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/airtime/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        amount: amount,
                        network: network,
                        payment_method: paymentMethod,
                        phone: paymentMethod === 'push' ? formatPhoneNumber(phone) : null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message || 'Request submitted successfully!', 'success');
                    refreshBalance();
                } else {
                    showNotification(data.message || 'Failed to process request', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            }
            
            setLoading('sellAirtimeBtn', false);
        }

        // Handle Deposit
        async function handleDeposit(event) {
            event.preventDefault();
            if (!checkSession()) return;
            
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const phone = document.getElementById('depositPhone').value;
            
            if (amount < 10) {
                showNotification('Minimum deposit is KES 10', 'error');
                return;
            }
            
            const formattedPhone = formatPhoneNumber(phone);
            if (!/^254(7|1)\d{8}$/.test(formattedPhone)) {
                showNotification('Invalid phone number format', 'error');
                return;
            }
            
            setLoading('depositBtn', true);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/payments/deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        phone: formattedPhone,
                        amount: amount
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('STK Push sent to your phone. Please enter your M-Pesa PIN.', 'success');
                    // Poll for payment status
                    pollPaymentStatus(data.reference || data.transactionId);
                } else {
                    showNotification(data.message || 'Failed to initiate deposit', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            }
            
            setLoading('depositBtn', false);
        }

        // Poll Payment Status
        async function pollPaymentStatus(reference) {
            let attempts = 0;
            const maxAttempts = 12;
            
            const poll = async () => {
                attempts++;
                try {
                    const response = await fetch(`${BACKEND_URL}/api/payments/status/${reference}`);
                    const data = await response.json();
                    
                    if (data.status === 'success' || data.success) {
                        showNotification('Deposit successful!', 'success');
                        refreshBalance();
                        return;
                    } else if (data.status === 'failed') {
                        showNotification('Deposit failed. Please try again.', 'error');
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    }
                } catch (error) {
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    }
                }
            };
            
            setTimeout(poll, 5000);
        }

        // Handle Withdraw
        async function handleWithdraw(event) {
            event.preventDefault();
            if (!checkSession()) return;
            
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const phone = document.getElementById('withdrawPhone').value;
            
            if (amount < 50) {
                showNotification('Minimum withdrawal is KES 50', 'error');
                return;
            }
            
            if (amount > parseFloat(currentUser.balance || 0)) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            const formattedPhone = formatPhoneNumber(phone);
            
            setLoading('withdrawBtn', true);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/payments/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        phone: formattedPhone,
                        amount: amount
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Withdrawal initiated successfully!', 'success');
                    refreshBalance();
                } else {
                    showNotification(data.message || 'Withdrawal failed', 'error');
                }
            } catch (error) {
                showNotification('Network error. Please try again.', 'error');
            }
            
            setLoading('withdrawBtn', false);
        }

        // Load Transactions
        async function loadTransactions() {
            const username = localStorage.getItem('username');
            const type = document.getElementById('filterType').value;
            const status = document.getElementById('filterStatus').value;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/transactions/${username}?page=${currentPage}&limit=20&type=${type}&status=${status}`);
                const data = await response.json();
                
                const tbody = document.getElementById('transactionsTable');
                
                if (data.success && data.transactions && data.transactions.length > 0) {
                    tbody.innerHTML = data.transactions.map(tx => `
                        <tr>
                            <td>${new Date(tx.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                            <td>${formatTransactionType(tx.type)}</td>
                            <td>KES ${parseFloat(tx.amount).toFixed(2)}</td>
                            <td><span class="status-badge status-${tx.status}">${tx.status}</span></td>
                            <td>${tx.provider_reference || tx.mpesa_code || '-'}</td>
                        </tr>
                    `).join('');
                    
                    // Update recent transactions on dashboard
                    updateRecentTransactions(data.transactions.slice(0, 5));
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No transactions found</td></tr>';
                }
            } catch (error) {
                document.getElementById('transactionsTable').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Failed to load transactions</td></tr>';
            }
        }

        // Format Transaction Type
        function formatTransactionType(type) {
            const types = {
                'deposit': 'Deposit',
                'airtime_purchase': 'Airtime Purchase',
                'airtime_to_cash': 'Sell Airtime',
                'direct_purchase': 'Direct Purchase',
                'withdrawal': 'Withdrawal',
                'adjustment': 'Adjustment'
            };
            return types[type] || type;
        }

        // Update Recent Transactions
        function updateRecentTransactions(transactions) {
            const tbody = document.getElementById('recentTransactions');
            if (transactions && transactions.length > 0) {
                tbody.innerHTML = transactions.map(tx => `
                    <tr>
                        <td>${new Date(tx.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</td>
                        <td>${formatTransactionType(tx.type)}</td>
                        <td>KES ${parseFloat(tx.amount).toFixed(2)}</td>
                        <td><span class="status-badge status-${tx.status}">${tx.status}</span></td>
                    </tr>
                `).join('');
            }
        }

        // Load Notifications
        async function loadNotifications() {
            const username = localStorage.getItem('username');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/${username}/notifications`);
                const data = await response.json();
                
                const container = document.getElementById('notificationsList');
                
                if (data.success && data.notifications && data.notifications.length > 0) {
                    container.innerHTML = data.notifications.map(notif => `
                        <div style="padding: 16px; border-bottom: 1px solid #e0e0e0; ${notif.is_read ? 'opacity: 0.7;' : ''}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong style="color: var(--${notif.level || 'info'});">${notif.title}</strong>
                                <small style="color: #666;">${new Date(notif.created_at).toLocaleDateString()}</small>
                            </div>
                            <p style="color: #666; margin: 0;">${notif.message}</p>
                        </div>
                    `).join('');
                    
                    // Update badge
                    const unreadCount = data.notifications.filter(n => !n.is_read).length;
                    const badge = document.getElementById('notificationBadge');
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No notifications</p>';
                }
            } catch (error) {
                console.error('Failed to load notifications');
            }
        }

        // Export PDF
        function exportPDF() {
            showNotification('PDF export feature coming soon!', 'info');
        }

        // Toggle Dark Mode
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.body.style.background = isDark ? '#1a1a2e' : 'var(--light)';
            // Additional dark mode styles can be added here
            saveUserSettings({ theme: isDark ? 'dark' : 'light' });
        }

        // Change Language
        function changeLanguage() {
            const lang = document.getElementById('languageSelect').value;
            saveUserSettings({ language: lang });
            showNotification('Language preference saved!', 'success');
        }

        // Save User Settings
        async function saveUserSettings(settings) {
            const username = localStorage.getItem('username');
            try {
                await fetch(`${BACKEND_URL}/api/users/${username}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            } catch (error) {
                console.error('Failed to save settings');
            }
        }

        // Logout
        function logout() {
            auth.signOut();
            localStorage.clear();
            showNotification('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }

        // Auto-refresh interval (every 30 seconds)
        let autoRefreshInterval = null;
        
        function startAutoRefresh() {
            // Auto-refresh balance every 30 seconds
            autoRefreshInterval = setInterval(() => {
                refreshBalanceSilent();
            }, 30000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }
        
        // Silent balance refresh (no notification)
        async function refreshBalanceSilent() {
            const username = localStorage.getItem('username');
            if (!username) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/${username}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('user_data', JSON.stringify(data.user));
                    updateUserDisplay();
                }
            } catch (error) {
                console.error('Auto-refresh failed');
            }
        }
        
        // Visibility change handler - refresh when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if (checkSession()) {
                    refreshBalanceSilent();
                }
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!checkSession()) return;
            
            const userData = localStorage.getItem('user_data');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUserDisplay();
            }
            
            // Refresh balance on load
            refreshBalance();
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Load initial data
            loadTransactions();
            loadNotifications();
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
  </html>
