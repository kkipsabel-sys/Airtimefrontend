<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtime Solutions - Login</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a73e8;
            --secondary: #34a853;
            --accent: #fbbc04;
            --dark: #202124;
            --light: #f8f9fa;
            --error: #ea4335;
            --success: #34a853;
            --warning: #fbbc04;
            --info: #4285f4;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #0d47a1 50%, var(--dark) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 450px;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-section img {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            margin-bottom: 15px;
        }

        .logo-section h1 {
            color: white;
            font-size: 28px;
            font-weight: 600;
        }

        .logo-section p {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-top: 8px;
        }

        .auth-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(26,115,232,0.05);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .form-container {
            padding: 30px;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }

        .input-wrapper {
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            padding-right: 45px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
        }

        .form-group input.valid {
            border-color: var(--success);
        }

        .form-group input.invalid {
            border-color: var(--error);
        }

        .validation-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }

        .validation-icon.valid {
            color: var(--success);
        }

        .validation-icon.invalid {
            color: var(--error);
        }

        .feedback {
            font-size: 12px;
            margin-top: 6px;
            display: block;
        }

        .feedback.valid {
            color: var(--success);
        }

        .feedback.invalid {
            color: var(--error);
        }

        .password-strength {
            margin-top: 8px;
            display: flex;
            gap: 4px;
        }

        .strength-bar {
            flex: 1;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            transition: background 0.3s;
        }

        .strength-bar.weak { background: var(--error); }
        .strength-bar.medium { background: var(--warning); }
        .strength-bar.strong { background: var(--success); }

        .strength-text {
            font-size: 12px;
            margin-top: 4px;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .checkbox-group label {
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        .checkbox-group a {
            color: var(--primary);
            text-decoration: none;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26,115,232,0.4);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn-text { display: inline; }
        .btn-loader { display: none; }
        .btn.loading .btn-text { display: none; }
        .btn.loading .btn-loader { display: inline-flex; align-items: center; gap: 8px; }

        #notificationContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }

        .notification {
            padding: 16px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            color: white;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .notification-success { background: var(--success); }
        .notification-error { background: var(--error); }
        .notification-warning { background: var(--warning); color: var(--dark); }
        .notification-info { background: var(--info); }

        .notification svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .notification span {
            flex: 1;
            font-size: 14px;
        }

        .notification button {
            background: none;
            border: none;
            color: inherit;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.8;
            padding: 0;
            line-height: 1;
        }

        .notification button:hover {
            opacity: 1;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .form-container {
                padding: 20px;
            }

            .logo-section h1 {
                font-size: 24px;
            }

            #notificationContainer {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="notificationContainer"></div>

    <div class="container">
        <div class="logo-section">
            <img src="airtime logo.png" alt="Airtime Solutions" onerror="this.style.display='none'">
            <h1>Airtime Solutions</h1>
            <p>Your trusted airtime and payment partner</p>
        </div>

        <div class="auth-card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('signin')">Sign In</div>
                <div class="tab" onclick="switchTab('signup')">Sign Up</div>
                <div class="tab" onclick="switchTab('forgot')">Forgot Password</div>
            </div>

            <div class="form-container">
                <!-- Sign In Form -->
                <div id="signin-form" class="form-section active">
                    <form onsubmit="handleSignIn(event)">
                        <div class="form-group">
                            <label>Email Address</label>
                            <div class="input-wrapper">
                                <input type="email" id="signin-email" placeholder="Enter your email" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <div class="input-wrapper">
                                <input type="password" id="signin-password" placeholder="Enter your password" required minlength="6">
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="remember-me">
                            <label for="remember-me">Remember me</label>
                        </div>

                        <button type="submit" class="btn btn-primary" id="signin-btn">
                            <span class="btn-text">Sign In</span>
                            <span class="btn-loader">
                                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                                </svg>
                                Signing in...
                            </span>
                        </button>
                    </form>
                </div>

                <!-- Sign Up Form -->
                <div id="signup-form" class="form-section">
                    <form onsubmit="handleSignUp(event)">
                        <div class="form-group">
                            <label>Username</label>
                            <div class="input-wrapper">
                                <input type="text" id="signup-username" placeholder="Choose a username" required oninput="validateUsername(this)">
                                <span class="validation-icon" id="username-icon"></span>
                            </div>
                            <span class="feedback" id="username-feedback"></span>
                        </div>

                        <div class="form-group">
                            <label>Email Address</label>
                            <div class="input-wrapper">
                                <input type="email" id="signup-email" placeholder="Enter your email" required oninput="validateEmail(this)">
                                <span class="validation-icon" id="email-icon"></span>
                            </div>
                            <span class="feedback" id="email-feedback"></span>
                        </div>

                        <div class="form-group">
                            <label>Phone Number</label>
                            <div class="input-wrapper">
                                <input type="tel" id="signup-phone" placeholder="07XXXXXXXX or +254XXXXXXXX" required oninput="validatePhone(this)">
                                <span class="validation-icon" id="phone-icon"></span>
                            </div>
                            <span class="feedback" id="phone-feedback"></span>
                        </div>

                        <div class="form-group">
                            <label>Password</label>
                            <div class="input-wrapper">
                                <input type="password" id="signup-password" placeholder="Create a password" required oninput="validatePassword(this)">
                                <span class="validation-icon" id="password-icon"></span>
                            </div>
                            <div class="password-strength" id="password-strength">
                                <div class="strength-bar" id="str1"></div>
                                <div class="strength-bar" id="str2"></div>
                                <div class="strength-bar" id="str3"></div>
                                <div class="strength-bar" id="str4"></div>
                            </div>
                            <span class="strength-text" id="strength-text"></span>
                            <span class="feedback" id="password-feedback"></span>
                        </div>

                        <div class="form-group">
                            <label>Confirm Password</label>
                            <div class="input-wrapper">
                                <input type="password" id="signup-confirm" placeholder="Confirm your password" required oninput="validateConfirmPassword(this)">
                                <span class="validation-icon" id="confirm-icon"></span>
                            </div>
                            <span class="feedback" id="confirm-feedback"></span>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="terms" required>
                            <label for="terms">I agree to the <a href="#">Terms & Conditions</a></label>
                        </div>

                        <button type="submit" class="btn btn-primary" id="signup-btn">
                            <span class="btn-text">Sign Up</span>
                            <span class="btn-loader">
                                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                                </svg>
                                Creating account...
                            </span>
                        </button>
                    </form>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgot-form" class="form-section">
                    <form onsubmit="handleForgotPassword(event)">
                        <div class="form-group">
                            <label>Email Address</label>
                            <div class="input-wrapper">
                                <input type="email" id="forgot-email" placeholder="Enter your registered email" required>
                            </div>
                            <span class="feedback" id="forgot-feedback"></span>
                        </div>

                        <button type="submit" class="btn btn-primary" id="forgot-btn">
                            <span class="btn-text">Send Reset Link</span>
                            <span class="btn-loader">
                                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
                                </svg>
                                Sending...
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase Configuration - Replace with your actual config
        const firebaseConfig = {
  apiKey: "AIzaSyBtx-D3nbl1lKOhCzEixDZRgRDM4NbtOBE",
  authDomain: "swiftauth-5fcb5.firebaseapp.com",
  projectId: "swiftauth-5fcb5",
  storageBucket: "swiftauth-5fcb5.firebasestorage.app",
  messagingSenderId: "990160652137",
  appId: "1:990160652137:web:abac238567edfdb5671ff8",
  measurementId: "G-5C1DS28B5S"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const BACKEND_URL = 'https://airtimebackend.onrender.com';

        // SVG Icons
        const icons = {
            success: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            error: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
            warning: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`,
            check: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`,
            x: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`
        };

        // Notification System
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            notification.innerHTML = `
                ${icons[type]}
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tab === 'signin' ? 1 : tab === 'signup' ? 2 : 3})`).classList.add('active');
            document.getElementById(`${tab}-form`).classList.add('active');
        }

        // Button Loading State
        function setLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (isLoading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Validation Icon Update
        function setValidationIcon(iconId, isValid) {
            const icon = document.getElementById(iconId);
            icon.innerHTML = isValid ? icons.check : icons.x;
            icon.className = `validation-icon ${isValid ? 'valid' : 'invalid'}`;
        }

        // Phone Number Formatter
        function formatPhoneNumber(phone) {
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '254' + cleaned.substring(1);
            } else if (cleaned.startsWith('+254')) {
                cleaned = cleaned.substring(1);
            } else if (!cleaned.startsWith('254')) {
                cleaned = '254' + cleaned;
            }
            return cleaned;
        }

        // Debounce function for API calls
        let debounceTimers = {};
        function debounce(key, func, delay) {
            clearTimeout(debounceTimers[key]);
            debounceTimers[key] = setTimeout(func, delay);
        }

        // Username Validation
        async function validateUsername(input) {
            const value = input.value.trim();
            const feedback = document.getElementById('username-feedback');
            
            if (value.length < 3 || value.length > 20) {
                input.classList.remove('valid');
                input.classList.add('invalid');
                setValidationIcon('username-icon', false);
                feedback.textContent = 'Username must be 3-20 characters';
                feedback.className = 'feedback invalid';
                return false;
            }

            if (!/^[a-zA-Z0-9]+$/.test(value)) {
                input.classList.remove('valid');
                input.classList.add('invalid');
                setValidationIcon('username-icon', false);
                feedback.textContent = 'Only letters and numbers allowed';
                feedback.className = 'feedback invalid';
                return false;
            }

            // Check availability with debounce
            debounce('username', async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/users/check-username/${value}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        input.classList.remove('valid');
                        input.classList.add('invalid');
                        setValidationIcon('username-icon', false);
                        feedback.textContent = 'Username is already taken';
                        feedback.className = 'feedback invalid';
                    } else {
                        input.classList.remove('invalid');
                        input.classList.add('valid');
                        setValidationIcon('username-icon', true);
                        feedback.textContent = 'Username is available';
                        feedback.className = 'feedback valid';
                    }
                } catch (error) {
                    feedback.textContent = 'Checking availability...';
                    feedback.className = 'feedback';
                }
            }, 500);

            return true;
        }

        // Email Validation
        async function validateEmail(input) {
            const value = input.value.trim();
            const feedback = document.getElementById('email-feedback');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(value)) {
                input.classList.remove('valid');
                input.classList.add('invalid');
                setValidationIcon('email-icon', false);
                feedback.textContent = 'Invalid email format';
                feedback.className = 'feedback invalid';
                return false;
            }

            // Check availability with debounce
            debounce('email', async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/users/check-email/${value}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        input.classList.remove('valid');
                        input.classList.add('invalid');
                        setValidationIcon('email-icon', false);
                        feedback.textContent = 'Email is already registered';
                        feedback.className = 'feedback invalid';
                    } else {
                        input.classList.remove('invalid');
                        input.classList.add('valid');
                        setValidationIcon('email-icon', true);
                        feedback.textContent = 'Email is available';
                        feedback.className = 'feedback valid';
                    }
                } catch (error) {
                    feedback.textContent = 'Valid email format';
                    feedback.className = 'feedback valid';
                }
            }, 500);

            return true;
        }

        // Phone Validation
        function validatePhone(input) {
            const value = input.value.trim();
            const feedback = document.getElementById('phone-feedback');
            const cleaned = value.replace(/\D/g, '');
            
            const isValid = /^(254|0)(7|1)\d{8}$/.test(cleaned) || /^(\+254)(7|1)\d{8}$/.test(value);
            
            if (isValid) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                setValidationIcon('phone-icon', true);
                feedback.textContent = 'Valid Kenyan phone number';
                feedback.className = 'feedback valid';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                setValidationIcon('phone-icon', false);
                feedback.textContent = 'Enter valid Kenyan number (07/01/+254)';
                feedback.className = 'feedback invalid';
            }
            
            return isValid;
        }

        // Password Validation
        function validatePassword(input) {
            const value = input.value;
            const feedback = document.getElementById('password-feedback');
            const strengthText = document.getElementById('strength-text');
            
            let strength = 0;
            if (value.length >= 8) strength++;
            if (/[A-Z]/.test(value)) strength++;
            if (/[a-z]/.test(value)) strength++;
            if (/[0-9]/.test(value)) strength++;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(value)) strength++;

            // Update strength bars
            const bars = ['str1', 'str2', 'str3', 'str4'];
            bars.forEach((bar, index) => {
                const el = document.getElementById(bar);
                el.className = 'strength-bar';
                if (strength > index) {
                    if (strength <= 2) el.classList.add('weak');
                    else if (strength <= 3) el.classList.add('medium');
                    else el.classList.add('strong');
                }
            });

            // Update strength text
            if (strength <= 2) {
                strengthText.textContent = 'Weak password';
                strengthText.style.color = 'var(--error)';
            } else if (strength <= 3) {
                strengthText.textContent = 'Medium password';
                strengthText.style.color = 'var(--warning)';
            } else {
                strengthText.textContent = 'Strong password';
                strengthText.style.color = 'var(--success)';
            }

            const isValid = value.length >= 8 && 
                           /[A-Z]/.test(value) && 
                           /[a-z]/.test(value) && 
                           /[0-9]/.test(value) && 
                           /[!@#$%^&*(),.?":{}|<>]/.test(value);

            if (isValid) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                setValidationIcon('password-icon', true);
                feedback.textContent = '';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                setValidationIcon('password-icon', false);
                feedback.textContent = 'Must contain: 8+ chars, uppercase, lowercase, number, special char';
                feedback.className = 'feedback invalid';
            }

            // Also validate confirm password if filled
            const confirmInput = document.getElementById('signup-confirm');
            if (confirmInput.value) {
                validateConfirmPassword(confirmInput);
            }

            return isValid;
        }

        // Confirm Password Validation
        function validateConfirmPassword(input) {
            const password = document.getElementById('signup-password').value;
            const value = input.value;
            const feedback = document.getElementById('confirm-feedback');
            
            const isValid = value === password && value.length > 0;
            
            if (isValid) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                setValidationIcon('confirm-icon', true);
                feedback.textContent = 'Passwords match';
                feedback.className = 'feedback valid';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                setValidationIcon('confirm-icon', false);
                feedback.textContent = 'Passwords do not match';
                feedback.className = 'feedback invalid';
            }
            
            return isValid;
        }

        // Sign In Handler
        async function handleSignIn(event) {
            event.preventDefault();
            setLoading('signin-btn', true);
            
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;
            
            try {
                // Check if email has associated username first
                const checkResponse = await fetch(`${BACKEND_URL}/api/users/check-email/${email}`);
                const checkData = await checkResponse.json();
                
                if (!checkData.exists) {
                    showNotification('No account found with this email. Please sign up first.', 'error');
                    setLoading('signin-btn', false);
                    return;
                }

                // Firebase sign in
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const token = await user.getIdToken();
                
                // Get user data from backend
                const userResponse = await fetch(`${BACKEND_URL}/api/users/firebase/${user.uid}`);
                const userData = await userResponse.json();
                
                if (!userData.success) {
                    showNotification('Account data not found. Please contact support.', 'error');
                    setLoading('signin-btn', false);
                    return;
                }

                // Store session data
                localStorage.setItem('user_token', token);
                localStorage.setItem('user_data', JSON.stringify(userData.user));
                localStorage.setItem('login_timestamp', Date.now().toString());
                localStorage.setItem('username', userData.user.username);
                
                showNotification('Login successful! Redirecting...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Sign in error:', error);
                let message = 'Login failed. Please try again.';
                
                if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/user-not-found') {
                    message = 'No account found with this email.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'Too many failed attempts. Please try again later.';
                }
                
                showNotification(message, 'error');
                setLoading('signin-btn', false);
            }
        }

        // Sign Up Handler
        async function handleSignUp(event) {
            event.preventDefault();
            
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const phone = document.getElementById('signup-phone').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm').value;
            const termsAccepted = document.getElementById('terms').checked;

            // Validate all fields
            if (!username || !email || !phone || !password || !confirmPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (!termsAccepted) {
                showNotification('Please accept the Terms & Conditions', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            // Check password strength
            const passwordValid = password.length >= 8 && 
                                 /[A-Z]/.test(password) && 
                                 /[a-z]/.test(password) && 
                                 /[0-9]/.test(password) && 
                                 /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            if (!passwordValid) {
                showNotification('Password does not meet requirements', 'error');
                return;
            }

            setLoading('signup-btn', true);

            try {
                // Create Firebase user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Format phone number
                const formattedPhone = formatPhoneNumber(phone);
                
                // Register user in backend database
                const registerResponse = await fetch(`${BACKEND_URL}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firebase_uid: user.uid,
                        username: username,
                        email: email,
                        phone: formattedPhone
                    })
                });

                const registerData = await registerResponse.json();

                if (!registerData.success) {
                    // If backend registration fails, delete Firebase user
                    await user.delete();
                    showNotification(registerData.message || 'Registration failed', 'error');
                    setLoading('signup-btn', false);
                    return;
                }

                // Get token and store session
                const token = await user.getIdToken();
                
                localStorage.setItem('user_token', token);
                localStorage.setItem('user_data', JSON.stringify(registerData.user));
                localStorage.setItem('login_timestamp', Date.now().toString());
                localStorage.setItem('username', username);
                
                showNotification('Account created successfully! Redirecting...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                
            } catch (error) {
                console.error('Sign up error:', error);
                let message = 'Registration failed. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'This email is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password is too weak.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address.';
                }
                
                showNotification(message, 'error');
                setLoading('signup-btn', false);
            }
        }

        // Forgot Password Handler
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgot-email').value.trim();
            const feedback = document.getElementById('forgot-feedback');
            
            if (!email) {
                showNotification('Please enter your email address', 'error');
                return;
            }

            setLoading('forgot-btn', true);

            try {
                // Check if email exists in backend
                const checkResponse = await fetch(`${BACKEND_URL}/api/users/check-email/${email}`);
                const checkData = await checkResponse.json();
                
                if (!checkData.exists) {
                    showNotification('No account found with this email address', 'error');
                    setLoading('forgot-btn', false);
                    return;
                }

                // Send password reset email via Firebase
                await auth.sendPasswordResetEmail(email);
                
                showNotification('Password reset link sent to your email!', 'success');
                feedback.textContent = 'Check your email inbox for the reset link';
                feedback.className = 'feedback valid';
                
                // Clear the form
                document.getElementById('forgot-email').value = '';
                
            } catch (error) {
                console.error('Forgot password error:', error);
                let message = 'Failed to send reset email. Please try again.';
                
                if (error.code === 'auth/user-not-found') {
                    message = 'No account found with this email.';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address.';
                }
                
                showNotification(message, 'error');
            }
            
            setLoading('forgot-btn', false);
        }

        // Check if already logged in
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('user_token');
            const loginTimestamp = localStorage.getItem('login_timestamp');
            
            if (token && loginTimestamp) {
                const hoursDiff = (Date.now() - parseInt(loginTimestamp)) / (1000 * 60 * 60);
                if (hoursDiff < 24) {
                    window.location.href = 'index.html';
                } else {
                    localStorage.clear();
                }
            }
        });
    </script>
</body>
  </html>
